	<!DOCTYPE html>
	<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<title>Skydive local topology</title>
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet"/>

		<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="http://cytoscape.github.io/cytoscape.js/api/cytoscape.js-latest/cytoscape.min.js"></script>
		<script src="https://cdn.rawgit.com/cpettitt/dagre/v0.7.4/dist/dagre.min.js"></script>
		<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-dagre/1.1.2/cytoscape-dagre.js"></script>

		<script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.js"></script>
		<link href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.css" rel="stylesheet" type="text/css" />
		<script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-qtip/2.2.5/cytoscape-qtip.js"></script>

		<style>
		body {
			padding-top: 50px;
			background-color: #eee;
		}
		#cy {
			width: 100%;
			height: 100%;
			display: block;
			position: absolute;
		}
		</style>

		<script>
			var switchImg = 'https://cdn2.iconfinder.com/data/icons/windows-8-metro-style/64/switch.png';
			var portImg = 'https://cdn2.iconfinder.com/data/icons/windows-8-metro-style/64/flow_chart.png';
			var intfImg = 'https://cdn2.iconfinder.com/data/icons/windows-8-metro-style/64/wired_network.png';

			function addTooltip(cy, id, el) {
				if (!("Metadatas" in el))
					return;

				var metadata = '';
				for (k in el["Metadatas"]) {
					metadata += k + ': ' + el["Metadatas"][k] + "<br/>";
				}

				cy.$('#' + id).qtip({
					content: {
						title:'Metadatas',
						text: metadata
					},
					style: {
						classes: 'qtip-bootstrap'
					}
				});
			}

			function drawTopology(topology) {
				var cy = cytoscape({
					ready: function(){
						window.cy = this;
					},
					container: document.getElementById('cy'),
					pan: { x: 100, y: 0 },
					minZoom: 0.2,
					maxZoom: 1,
					zoomingEnabled: true,
					userZoomingEnabled: true,
					panningEnabled: true,
					userPanningEnabled: true,
					boxSelectionEnabled: true,
				    style: [ // the stylesheet for the graph
					    {
					    	selector: 'node',
					    	style: {
					    		'background-color': '#fff',
					    		'label': 'data(label)',
					    		'shape': 'rectangle',
					    		'background-image': 'data(img)',
					    		'shape': 'roundrectangle',
					    		'font-size': 22
					    	}
					    },
				        {
					    	selector: '[img!="none"]',
					    	style: {
					    		'width': 64,
					    		'height': 64
					    	}
					    },
					    {
					    	selector: '$node > node',
					    	css: {
					    		'padding-top': '10px',
					    		'padding-left': '10px',
					    		'padding-bottom': '10px',
					    		'padding-right': '10px',
					    		'text-valign': 'top',
					    		'text-halign': 'center',
					    		'background-color': '#aaa',
					    		'shape': 'roundrectangle'
					    	}
					    },
					    {
					    	selector: 'edge',
					    	style: {
					    		'width': 4,
					    		'line-color': '#333',
					    		'line-style': 'data(style)',
					    		'target-arrow-color': '#333'
					    	}
					    }
				    ],
				    layout: {
				    	name: 'dagre',
				    	fit: true
				    }
				});

				peering = {};
				uuidToId = {};

				// first to draw all the nodes
				for (var bridgeName in topology["OvsBridges"]) {
					bridgeId = bridgeName

					bridgeBoxId = 'OvsBridges_' + bridgeId;
					cy.add({data: {id: bridgeBoxId, label: 'OvsBridge', img: 'none'}});

					cy.add({data: {id: bridgeId, label: bridgeName, parent: bridgeBoxId, img: switchImg}});

					ports = topology["OvsBridges"][bridgeName]["Ports"]
					for (var portName in ports) {
						portId = bridgeId + portName

						cy.add({data: {id: portId, label: portName, parent: bridgeBoxId, img: portImg}});

						addTooltip(cy, portId, ports[portName]);

						// bridge to port
						cy.add({data: {id: bridgeId + '->' + portId, source: bridgeId, target: portId, style: "solid", weight: 20}});

						intfs = ports[portName]["Interfaces"]
						for (var intfName in intfs) {
							intfId = portId + intfName

							uuid = intfs[intfName]["UUID"];
							uuidToId[uuid] = intfId;

							cy.add({data: {id: intfId, label: intfName, parent: bridgeBoxId, img: intfImg}});

							addTooltip(cy, intfId, intfs[intfName]);

							// port to intf
							cy.add({data: {id: portId + '->' + intfId, source: portId, target: intfId, style: "solid", weight: 20}});

							if ("Peer" in intfs[intfName] && intfs[intfName]["Peer"]) {
								peerUUID = intfs[intfName]["Peer"]
								if (!(uuid in peering) && !(peerUUID in peering))
									peering[uuid] = peerUUID
							}
						}
					}
				}

				var ns = 0;
				for (var nsName in topology["NetNss"]) {
					nsId = nsName

					// skip netns with only one interface meaning only the loopback
					if (Object.keys(topology["NetNss"][nsName]["Interfaces"]).length < 2) {
						continue;
					}

					var parentId = '';
					if (nsName != "root") {
						cy.add({data: {id: nsId, label: nsName, img: 'none'}});
						parentId = nsId;
					}

					intfs = topology["NetNss"][nsName]["Interfaces"]
					for (var intfName in intfs) {
						intfId = nsId + intfName

						cy.add({data: {id: intfId, label: intfName, parent: parentId, img: intfImg}});

						addTooltip(cy, intfId, intfs[intfName]);

						// if already in ovs add a dotted link since this is the same interface that is
						// in an ovs bridge and in a netns
						uuid = intfs[intfName]["UUID"]
						if (uuid in uuidToId) {
							cy.add({data: {id: uuid + '->' + uuid, source: uuidToId[uuid], target: intfId, style: "dotted", weight: 1}});
						}
						uuidToId[uuid] = intfId;

						if ("Peer" in intfs[intfName] && intfs[intfName]["Peer"]) {
							peerUUID = intfs[intfName]["Peer"]
							if (!(peerUUID in peering))
								peering[uuid] = peerUUID
						}
					}
				}

				for (var uuid in peering) {
					sourceId = uuidToId[uuid]
					targetId = uuidToId[peering[uuid]]
					cy.add({data: {id: sourceId + '->' + targetId, source: sourceId, target: targetId, style: "dashed", weight: 3}});
				}


			}

			$(document).ready(function() {
				$.ajax({
					url: '/topology.json',
					data: {
						format: 'json'
					},
					error: function() {
					},
					dataType: 'json',
					success: function(data) {
						drawTopology(data);
					},
					type: 'GET'
				});
			});
			</script>
		</head>

		<body>
			<nav class="navbar navbar-inverse navbar-fixed-top">
				<div class="container">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="#">Skydive</a>
					</div>
					<div id="navbar" class="collapse navbar-collapse">
						<ul class="nav navbar-nav">
							<li class="active"><a href="#">Home</a></li>
						</ul>
					</div>
				</div>
			</nav>

			<div id="cy"/>

			<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
			<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		</body>
		</html>
